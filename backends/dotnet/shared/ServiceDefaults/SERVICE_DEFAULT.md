# ServiceDefaults

Shared Aspire configuration providing observability infrastructure (OpenTelemetry, Serilog), health checks, service discovery, and resilience patterns. Configures LGTM stack integration (Loki, Grafana, Tempo, Mimir) for all microservices.

## Files

| File Name                                                                      | Description                                                                                                                                                                                                                                                                                               |
|--------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [Extensions.cs](Extensions.cs)                                                 | Public API for adding service defaults to IHostApplicationBuilder with structured logging, OpenTelemetry, health checks, and HTTP client configuration. Contains IP allowlist logic for metrics endpoint (localhost + Docker networks 172.17-20.0.0/16).                                                  |
| [Extensions.IHostApplicationBuilder.cs](Extensions.IHostApplicationBuilder.cs) | Internal implementation. `AddServiceDefaults()` calls `D2Env.Load()` + `AddEnvironmentVariables()` to pick up `.env` transforms, then configures Serilog (console + Loki sink), OpenTelemetry tracing/metrics (ASP.NET Core, gRPC, HTTP client, runtime, process), Prometheus exporter, OTLP trace exporter, and health checks. Filters out infrastructure endpoints (/health, /alive, /metrics) from traces and logs. |
| [Extensions.WebApplication.cs](Extensions.WebApplication.cs)                   | WebApplication middleware configuration with UseStructuredRequestLogging (enriches logs with UserAgent, RemoteIp, TraceId), MapDefaultEndpoints (health/alive checks in dev only), and MapPrometheusEndpointWithIpRestriction (403 for unauthorized IPs).                                                 |
