# D2-WORX Environment Variables
# Copy this file to .env.local and fill in your values.
# WARNING: Never commit .env.local to version control.
#
# Convention: SERVICE_LAYER__PROPERTY (double underscore = hierarchy separator).
# .NET AddEnvironmentVariables() auto-maps __ to : for IConfiguration binding.
# Node.js services parse the same env vars directly.

# ===========================================
# Service Startup
# ===========================================
# When true, .NET services apply EF Core migrations on startup (local dev).
AUTO_MIGRATE=true

# ===========================================
# Infrastructure (Aspire Parameters)
# ===========================================
DB_USERNAME=postgres
DB_PASSWORD=your_secure_password_here
DBA_EMAIL=admin@example.com
DBA_PASSWORD=your_secure_password_here
MQ_USERNAME=rabbitmq
MQ_PASSWORD=your_secure_password_here
CACHE_PASSWORD=your_secure_password_here
S3_USERNAME=minio
S3_PASSWORD=your_secure_password_here
OTEL_USERNAME=admin
OTEL_PASSWORD=your_secure_password_here

# ===========================================
# Geo Service — Infra Options (GEO_INFRA)
# ===========================================
# IPInfo API token for WhoIs/geolocation lookups
# Get a free token at https://ipinfo.io/signup
GEO_INFRA__IPINFOACCESSTOKEN=your_ipinfo_token_here

# ===========================================
# Geo Service — App Options (GEO_APP)
# ===========================================
# Maps API keys to allowed context keys for contact operations.
# Format: GEO_APP__APIKEYMAPPINGS__<api-key>__<index>=<context-key>
# Auth — org contacts + user contacts
GEO_APP__APIKEYMAPPINGS__your_auth_api_key_here__0=org_contact
GEO_APP__APIKEYMAPPINGS__your_auth_api_key_here__1=user
# Comms — needs all contact types for recipient resolution
GEO_APP__APIKEYMAPPINGS__your_comms_api_key_here__0=org_contact
GEO_APP__APIKEYMAPPINGS__your_comms_api_key_here__1=user
# Distributed lock TTL in seconds (default: 300 = 5 min)
GEO_APP__JOBLOCKTTLSECONDS=300
# WhoIs retention in days (default: 180)
GEO_APP__WHOISRETENTIONDAYS=180

# Geo API key mapping for gateway (allows gateway to call Geo job RPCs)
GEO_APP__APIKEYMAPPINGS__your_gateway_api_key_here__0=_gateway

# ===========================================
# Geo Service — gRPC Address (for Node.js consumers)
# ===========================================
# The Geo .NET service gRPC endpoint (HTTP/2). Used by auth + comms Node services.
GEO_GRPC_ADDRESS=localhost:5138

# ===========================================
# Geo Client Options — Shared Defaults (GEO_CLIENT)
# ===========================================
# All Geo client consumers inherit these. Override per-service with {PREFIX}_GEO_CLIENT.
# GEO_CLIENT__WHOISCACHEMAXENTRIES=10000

# ===========================================
# Geo Client Options — Auth Service Overrides (AUTH_GEO_CLIENT)
# ===========================================
# API key for authenticating to Geo service contact operations (must match a key above)
AUTH_GEO_CLIENT__APIKEY=your_api_key_here
# Note: allowedContextKeys are hardcoded in auth composition-root (GEO_CONTEXT_KEYS constants)

# ===========================================
# Geo Client Options — Comms Service Overrides (COMMS_GEO_CLIENT)
# ===========================================
# API key for authenticating to Geo service contact operations (must match a key above)
COMMS_GEO_CLIENT__APIKEY=your_api_key_here
# Note: Comms resolves recipients across all context types (no client-side restriction)

# ===========================================
# Auth Service (Node.js / Hono + BetterAuth)
# ===========================================
# Database URL is injected by Aspire (ConnectionStrings__d2-services-auth).
# Redis + RabbitMQ URLs also injected via Aspire refs.
AUTH_BASE_URL=http://localhost:5100
AUTH_CORS_ORIGIN=http://localhost:5173
AUTH_JWT_ISSUER=d2-worx
AUTH_JWT_AUDIENCE=d2-services
# Auth gRPC server port (for gateway → auth job calls)
AUTH_GRPC_PORT=5101
# Auth API keys accepted by the Auth gRPC server (gateway uses this to authenticate)
AUTH_API_KEYS__0=your_gateway_api_key_here

# ===========================================
# Auth App Options (AUTH_APP)
# ===========================================
# Sign-in event retention in days (default: 90)
AUTH_APP__SIGNINEVENTRETENTIONDAYS=90
# Invitation retention after expiry in days (default: 7)
AUTH_APP__INVITATIONRETENTIONDAYS=7
# Distributed lock TTL in milliseconds (default: 300000 = 5 min)
AUTH_APP__JOBLOCKTTLMS=300000

# ===========================================
# Comms Service (Node.js / headless consumer + gRPC)
# ===========================================
# Database URL is injected by Aspire (ConnectionStrings__d2-services-comms).
# RabbitMQ URL also injected via Aspire refs.
# API keys for callers authenticating to the Comms gRPC service
# Format: COMMS_API_KEYS__<index>=<key>
# Auth service key
COMMS_API_KEYS__0=your_auth_comms_api_key_here
# REST gateway key (for gateway → comms job calls)
COMMS_API_KEYS__1=your_gateway_api_key_here
GRPC_PORT=5200

# ===========================================
# Comms App Options (COMMS_APP)
# ===========================================
# Soft-deleted message retention in days (default: 90)
COMMS_APP__DELETEDMESSAGERETENTIONDAYS=90
# Delivery history retention in days (default: 365)
COMMS_APP__DELIVERYHISTORYRETENTIONDAYS=365
# Distributed lock TTL in milliseconds (default: 300000 = 5 min)
COMMS_APP__JOBLOCKTTLMS=300000

# Resend — Email provider
# Sign up for a free API key at https://resend.com/signup (100 emails/day free)
# For dev/testing, use the built-in test domain: onboarding@resend.dev
RESEND_API_KEY=re_your_api_key_here
RESEND_FROM_ADDRESS=onboarding@resend.dev

# Twilio — SMS provider (optional, SMS is a fallback channel)
# Sign up for a free trial at https://www.twilio.com/try-twilio ($15 credit)
# Get Account SID + Auth Token from https://console.twilio.com
# Buy a phone number from the console (costs ~$1.15/mo from trial credit)
TWILIO_ACCOUNT_SID=AC_your_account_sid_here
TWILIO_AUTH_TOKEN=your_auth_token_here
TWILIO_PHONE_NUMBER=+1your_twilio_number_here

# ===========================================
# REST Gateway — JWT Auth (GATEWAY_AUTH)
# ===========================================
# Auth service base URL (for JWKS endpoint discovery)
GATEWAY_AUTH__AUTHSERVICEBASEURL=http://localhost:5100
# JWT issuer (must match AUTH_JWT_ISSUER)
GATEWAY_AUTH__ISSUER=d2-worx
# JWT audience (must match AUTH_JWT_AUDIENCE)
GATEWAY_AUTH__AUDIENCE=d2-services

# ===========================================
# REST Gateway — Service-to-Service API Keys (GATEWAY_SERVICEKEY)
# ===========================================
# Valid API keys for backend callers (SvelteKit, etc.) hitting service-only REST endpoints.
# Format: GATEWAY_SERVICEKEY__VALIDKEYS__<index>=<key>
GATEWAY_SERVICEKEY__VALIDKEYS__0=your_service_key_here
# Dkron service key (for Dkron → gateway job trigger calls)
GATEWAY_SERVICEKEY__VALIDKEYS__1=your_dkron_service_key_here

# ===========================================
# REST Gateway — gRPC API Keys (gateway → service)
# ===========================================
# API keys the gateway sends to authenticate with service gRPC job endpoints
GATEWAY_AUTH_GRPC_API_KEY=your_gateway_api_key_here
GATEWAY_GEO_GRPC_API_KEY=your_gateway_api_key_here
GATEWAY_COMMS_GRPC_API_KEY=your_gateway_api_key_here

# ===========================================
# Dkron Manager — Job Reconciler (DKRON_MGR)
# ===========================================
# Dkron API base URL (host-side port, since dkron-mgr runs on host via tsx)
DKRON_MGR__DKRON_URL=http://localhost:8888
# Gateway URL as seen from inside Docker (Dkron container → host gateway)
DKRON_MGR__GATEWAY_URL=http://host.docker.internal:5461
# Service key for Dkron → Gateway auth (must match GATEWAY_SERVICEKEY__VALIDKEYS__1)
DKRON_MGR__SERVICE_KEY=your_dkron_service_key_here
# Reconciliation interval in milliseconds (default: 300000 = 5 min)
DKRON_MGR__RECONCILE_INTERVAL_MS=300000

# ===========================================
# SvelteKit / Web Client
# ===========================================
PUBLIC_API_URL=http://localhost:5000
# Comma-separated list of allowed hosts for Vite dev server (optional)
VITE_ALLOWED_HOSTS=localhost
