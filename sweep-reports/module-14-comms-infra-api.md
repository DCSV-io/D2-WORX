### Module 14: Comms Infra + API

**Files reviewed**: 31 source files (25 infra + 6 API)

**Source files**:

| #   | File                                                                                                      | Lines    |
| --- | --------------------------------------------------------------------------------------------------------- | -------- |
| 1   | `backends/node/services/comms/infra/src/index.ts`                                                         | 44       |
| 2   | `backends/node/services/comms/infra/src/registration.ts`                                                  | 107      |
| 3   | `backends/node/services/comms/infra/src/service-keys.ts`                                                  | 19       |
| 4   | `backends/node/services/comms/infra/src/repository/schema/tables.ts`                                      | 103      |
| 5   | `backends/node/services/comms/infra/src/repository/schema/index.ts`                                       | 17       |
| 6   | `backends/node/services/comms/infra/src/repository/schema/types.ts`                                       | 19       |
| 7   | `backends/node/services/comms/infra/src/repository/migrate.ts`                                            | 21       |
| 8   | `backends/node/services/comms/infra/src/repository/handlers/factories.ts`                                 | 64       |
| 9   | `backends/node/services/comms/infra/src/repository/handlers/c/create-message-record.ts`                   | 45       |
| 10  | `backends/node/services/comms/infra/src/repository/handlers/c/create-delivery-request-record.ts`          | 36       |
| 11  | `backends/node/services/comms/infra/src/repository/handlers/c/create-delivery-attempt-record.ts`          | 39       |
| 12  | `backends/node/services/comms/infra/src/repository/handlers/c/create-channel-preference-record.ts`        | 35       |
| 13  | `backends/node/services/comms/infra/src/repository/handlers/r/find-message-by-id.ts`                      | 58       |
| 14  | `backends/node/services/comms/infra/src/repository/handlers/r/find-delivery-request-by-id.ts`             | 53       |
| 15  | `backends/node/services/comms/infra/src/repository/handlers/r/find-delivery-request-by-correlation-id.ts` | 36       |
| 16  | `backends/node/services/comms/infra/src/repository/handlers/r/find-delivery-attempts-by-request-id.ts`    | 50       |
| 17  | `backends/node/services/comms/infra/src/repository/handlers/r/find-channel-preference-by-contact-id.ts`   | 48       |
| 18  | `backends/node/services/comms/infra/src/repository/handlers/u/mark-delivery-request-processed.ts`         | 31       |
| 19  | `backends/node/services/comms/infra/src/repository/handlers/u/update-delivery-attempt-status.ts`          | 33       |
| 20  | `backends/node/services/comms/infra/src/repository/handlers/u/update-channel-preference-record.ts`        | 36       |
| 21  | `backends/node/services/comms/infra/src/repository/handlers/q/ping-db.ts`                                 | 27       |
| 22  | `backends/node/services/comms/infra/src/providers/email/resend/resend-email-provider.ts`                  | 50       |
| 23  | `backends/node/services/comms/infra/src/providers/sms/twilio/twilio-sms-provider.ts`                      | 48       |
| 24  | `backends/node/services/comms/infra/src/messaging/consumers/notification-consumer.ts`                     | 135      |
| 25  | `backends/node/services/comms/infra/src/messaging/retry-topology.ts`                                      | 60       |
| 26  | `backends/node/services/comms/api/src/index.ts`                                                           | 8        |
| 27  | `backends/node/services/comms/api/src/main.ts`                                                            | 80       |
| 28  | `backends/node/services/comms/api/src/composition-root.ts`                                                | 230      |
| 29  | `backends/node/services/comms/api/src/services/comms-grpc-service.ts`                                     | 229      |
| 30  | `backends/node/services/comms/api/src/mappers/channel-preference-mapper.ts`                               | 13       |
| 31  | `backends/node/services/comms/api/src/mappers/delivery-mapper.ts`                                         | 30       |
|     | **Total**                                                                                                 | **1804** |

Also reviewed: `COMMS_INFRA.md` (215 lines), `COMMS_API.md` (149 lines), proto contracts, domain entities, app interfaces, app registration, comms-client publisher, service-defaults gRPC utilities.

---

**Assumptions documented**:

1. Drizzle ORM parameterizes all queries, so no SQL injection risk from user-controlled inputs passed through the `eq()` operator.
2. The `message.metadata` column is `jsonb` and is stored/retrieved as opaque `Record<string, unknown>` with no schema validation at the infra layer (validation is expected to happen in the app layer or at the consumer).
3. All primary keys are UUIDv7 strings (varchar 36), generated in the domain layer before reaching infra.
4. Timestamps from PostgreSQL (`timestamptz` columns) are returned by Drizzle as JavaScript `Date` objects, matching the domain entity types.
5. `CreateMessageRecord` and the other create handlers return `D2Result.ok({ data: {} })` (empty data), not the inserted row. The assumption is that the caller already holds the domain entity and does not need it echoed back.
6. The `toMessage()`, `toDeliveryRequest()`, `toDeliveryAttempt()`, and `toChannelPreference()` row-to-domain mappers perform unsafe casts (e.g., `row.contentFormat as ContentFormat`, `row.urgency as Urgency`, `row.channel as Channel`, `row.status as DeliveryStatus`). The assumption is that data integrity is enforced at write time (domain entity factories validate enums).
7. `runMigrations()` resolves the path relative to `import.meta.dirname`, going up to package root then down into `src/repository/migrations`. This assumes both `src/` and `dist/` are at the same depth from the package root.
8. The notification consumer casts `msg.body` to `NotificationMessage` without Zod validation. It relies on a structural check (`!body.recipientContactId || !body.title || !body.correlationId`) and trusts that `@d2/comms-client` Notify handler's Zod validation ensures correct shape.
9. The `geoClient` variable in `composition-root.ts` is assigned `undefined as never` when geo is not configured, which will cause a runtime crash when `GetContactsByIds` attempts to use the gRPC client. This is intentional (per the warn log).
10. The `ResendEmailProvider` does a non-null assertion on `data!.id` (line 47) after checking `error`, relying on Resend's API contract that `data` is non-null when `error` is null.
11. The `COMMS_INFRA.md` documents `addCommsInfra(services, db, config)` with a third `config` parameter for provider API keys, but the actual implementation signature is `addCommsInfra(services, db)` -- provider registration happens in the composition root. The documentation is stale.
12. Proto `ChannelPreferenceDTO` has fields `userId`, `quietHoursStart`, `quietHoursEnd`, `quietHoursTz` that the mapper never populates; proto `DeliveryRequestDTO` has `recipientUserId` and `templateName` that the mapper never populates. These are proto-level future placeholders.
13. The retry publisher in `scheduleRetry()` sends the original message body (typed as `Record<string, unknown> | NotificationMessage`), preserving the original shape for re-processing after the tier queue TTL expires.
14. The gRPC server binds with `createInsecure()` credentials -- this assumes TLS termination happens at the infrastructure level (load balancer, service mesh), not at the application level.
15. `main.ts` does not call `setupTelemetry()` from `@d2/service-defaults`. The `COMMS_API.md` documents that "OTel bootstrap in main.ts" is a design decision, but the code does not actually do it. OTel is presumably bootstrapped by the parent process (Aspire) or is pending.

---

**Findings**:

| #   | Severity | Category        | File:Line                                                               | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| --- | -------- | --------------- | ----------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------- | --- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | High     | Bug             | `api/src/main.ts:—`                                                     | **Missing OTel setup.** `main.ts` does not call `setupTelemetry()` from `@d2/service-defaults`, despite `COMMS_API.md` explicitly stating "OTel bootstrap in main.ts — `setupTelemetry` called before any imports to ensure instrumentation hooks early." Either the doc is aspirational, or this was accidentally omitted. Without it, the comms service runs without OpenTelemetry auto-instrumentation (no gRPC/PG/RabbitMQ traces).                                                                                                                                      |
| 2   | High     | Consistency     | `infra/COMMS_INFRA.md:155-163`                                          | **Stale documentation.** `COMMS_INFRA.md` shows the registration API as `addCommsInfra(services, db, config)` with a `CommsInfraConfig` type containing provider API keys. The actual implementation is `addCommsInfra(services: ServiceCollection, db: NodePgDatabase): void` with only 2 parameters. Providers are registered as singleton instances in the composition root. This will confuse any developer reading the docs.                                                                                                                                            |
| 3   | Medium   | Security        | `api/src/composition-root.ts:183-186`                                   | **API key auth can be silently disabled.** When `COMMS_API_KEYS` env vars are not set, the gRPC server starts with no authentication at all (`server.addService(CommsServiceService, grpcService)`). The only indication is a warn-level log. In production this would expose all RPCs (including `setChannelPreference`, `getDeliveryStatus`) to any caller without authentication. Consider failing hard in production environments or at least error-level logging.                                                                                                       |
| 4   | Medium   | Bug             | `api/src/services/comms-grpc-service.ts:66-79`                          | **Inconsistent NOT_FOUND handling in `getChannelPreference`.** When `result.success` is true but `result.data.pref` is `null` (contact has no prefs yet), the code returns a `D2Result.notFound()`. But having no preferences is a valid state (the contact simply hasn't set any). This should arguably return OK with `data: undefined` or default preferences, letting the caller distinguish "contact doesn't exist" from "no preferences set". The current behavior masks this distinction.                                                                             |
| 5   | Medium   | Consistency     | `infra/src/messaging/consumers/notification-consumer.ts:58-65`          | **No Zod validation on incoming messages.** The consumer does a manual 3-field presence check (`!body.recipientContactId                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                              | !body.title                                                                                                                            |     | !body.correlationId`) but does not validate the full message shape. Missing `content`or`plaintext`would silently pass through to the Deliver handler, potentially causing downstream failures. The`@d2/comms-client`Notify handler uses Zod validation, but a rogue publisher or manual RabbitMQ injection bypasses that. The consumer should validate with a Zod schema matching the`NotificationMessage` interface. |
| 6   | Medium   | Bug             | `infra/src/messaging/consumers/notification-consumer.ts:73-74`          | **Field name mismatch: `plaintext` vs `plainTextContent`.** The consumer maps `body.plaintext` to `plainTextContent` in the Deliver handler input. If the incoming message used `plainTextContent` (e.g., from a different publisher or a future refactor), it would be silently dropped. The field names should be documented as canonical, or the consumer should accept both. This is fragile coupling between `@d2/comms-client` (`plaintext`) and `@d2/comms-app` (`plainTextContent`).                                                                                 |
| 7   | Medium   | Consistency     | `api/src/mappers/delivery-mapper.ts:10`                                 | **`channels: []` hardcoded in `deliveryRequestToProto`.** The proto `DeliveryRequestDTO` has a `channels` field (`repeated string`), but the mapper always returns an empty array. The domain `DeliveryRequest` entity does not have a `channels` field (channels are determined dynamically at delivery time). If a consumer of the gRPC response inspects `channels`, they get misleading empty data. Consider omitting or removing the field from the proto, or populating it from the delivery attempts.                                                                 |
| 8   | Medium   | Consistency     | `api/src/mappers/channel-preference-mapper.ts:10-11`                    | **`createdAt` / `updatedAt` type mismatch potential.** The domain `ChannelPreference.createdAt` is `Date` but the proto `ChannelPreferenceDTO.createdAt` is `Date                                                                                                                                                                                                                                                                                                                                                                                                            | undefined`. The mapper assigns `pref.createdAt`directly. This works today because`Date`is assignable to`Date | undefined`, but the mapper does not handle the reverse direction (proto-to-domain). This is fine for read-only mappers but asymmetric. |
| 9   | Medium   | Maintainability | `infra/src/repository/handlers/factories.ts`                            | **Factories are dead code.** The `createMessageRepoHandlers()`, `createDeliveryRequestRepoHandlers()`, etc. are exported but not used by the DI registration (`registration.ts`) or the composition root. Registration uses individual handler constructors directly. The factories are only used by the integration test files (`deliver-handler.test.ts`). These factories add maintenance burden since any new handler must be added in two places (factories + DI registration). Consider either using factories consistently or removing them in favor of test helpers. |
| 10  | Medium   | Maintainability | `infra/src/service-keys.ts`                                             | **Re-export-only file adds indirection.** This file re-exports all service keys from `@d2/comms-app`. While documented as "convenience for the composition root," the composition root already imports directly from `@d2/comms-app`. The file is not used by any infra source file. It is exported from `index.ts` (it is not -- checked, the barrel does not export it). This is dead code.                                                                                                                                                                                |
| 11  | Low      | Elegance        | `infra/src/repository/handlers/u/update-delivery-attempt-status.ts:24`  | **`Record<string, unknown>` loses type safety.** The updates object is typed as `Record<string, unknown>` instead of using the Drizzle schema type. This bypasses column name checking. If a property name is mistyped (e.g., `providerMsgId` instead of `providerMessageId`), it would be silently ignored by Drizzle rather than caught at compile time. Use `Partial<typeof deliveryAttempt.$inferInsert>` or build the set object typed.                                                                                                                                 |
| 12  | Low      | Elegance        | `infra/src/repository/handlers/r/find-message-by-id.ts:47-52`           | **Unsafe enum casts in row-to-domain mappers.** `row.contentFormat as ContentFormat` and `row.urgency as Urgency` are unchecked casts. If the DB contains an invalid value (e.g., from a manual SQL update or migration), the cast silently produces an invalid domain object. Same applies to `find-delivery-attempts-by-request-id.ts:41-42` (`as Channel`, `as DeliveryStatus`). A runtime validation would be safer, though domain factory validation at write time mitigates this.                                                                                      |
| 13  | Low      | Elegance        | `infra/src/repository/handlers/u/mark-delivery-request-processed.ts:26` | **Silent no-op on missing row.** `MarkDeliveryRequestProcessed` always returns `D2Result.ok()` even if the `WHERE` clause matched zero rows (the ID doesn't exist). The handler does not check `rowCount`. Same issue in `UpdateDeliveryAttemptStatus` and `UpdateChannelPreferenceRecord`. If the caller provides a non-existent ID, they get a false success.                                                                                                                                                                                                              |
| 14  | Low      | Elegance        | `api/src/composition-root.ts:123`                                       | **`undefined as never` is a type-system lie.** When geo is not configured, `geoClient` is assigned `undefined as never`. This suppresses the TypeScript error but means `GetContactsByIds` receives an undefined client and will throw at runtime. A more explicit pattern would be to check for geoClient before constructing GetContactsByIds, or use a stub implementation that returns a clear error.                                                                                                                                                                    |
| 15  | Low      | Performance     | `api/src/services/comms-grpc-service.ts:140-184`                        | **Sequential queries in `getDeliveryStatus`.** The RPC first queries `FindDeliveryRequestById`, then sequentially queries `FindDeliveryAttemptsByRequestId`. These two queries are independent once the ID is validated and could be parallelized with `Promise.all()`. Impact is minimal (each query is fast), but it doubles the latency of this RPC.                                                                                                                                                                                                                      |
| 16  | Low      | Consistency     | `api/src/main.ts:52`                                                    | **Dual env var fallback for database URL.** `process.env["ConnectionStrings__d2-services-comms"] ?? process.env.ConnectionStrings__d2_services_comms` checks both hyphenated and underscored variants. The same pattern appears for RabbitMQ. This is pragmatic but undocumented. `COMMS_API.md` only shows `ConnectionStrings__d2_services_comms` (underscore). The hyphenated variant should be documented or the code should commit to one.                                                                                                                               |
| 17  | Low      | Consistency     | `infra/src/providers/email/resend/resend-email-provider.ts:47`          | **Non-null assertion on Resend response.** `data!.id` assumes the Resend SDK contract guarantees `data` is non-null when `error` is null. While this is documented Resend behavior, a defensive check would be more robust against SDK version changes.                                                                                                                                                                                                                                                                                                                      |
| 18  | Low      | Maintainability | `api/src/composition-root.ts:81`                                        | **Duplicate logger creation.** `main.ts` creates a logger (`createLogger({ serviceName: "comms-service" })`) for the startup check, and `composition-root.ts` creates another. Both use the same service name. The composition root's logger is passed into DI; the main.ts logger is only used for the early "missing env" check. Minor inefficiency and two logger instances.                                                                                                                                                                                              |
| 19  | Low      | Consistency     | `api/src/services/comms-grpc-service.ts:97-130`                         | **`setChannelPreference` does not validate input fields.** The gRPC handler passes `req.contactId`, `req.emailEnabled`, `req.smsEnabled` directly to the app handler without any server-side validation. Proto defaults (empty string for `contactId`, false for booleans) mean a missing `contactId` passes as an empty string. The app-layer `SetChannelPreference` handler should catch this, but belt-and-suspenders validation at the API boundary is a project pattern seen in other services.                                                                         |

---

**Tests to add**:

- [ ] **Channel preference repository integration test** (`integration/channel-preference-repository.test.ts`) -- CRUD operations for `CreateChannelPreferenceRecord`, `FindChannelPreferenceByContactId`, `UpdateChannelPreferenceRecord`. Currently untested at the infra level (only indirectly tested through the deliver handler integration test). The existing test files cover message, delivery-request, and delivery-attempt repositories but not channel-preference.
- [ ] **PingDb handler test** (unit or integration) -- Verify that `PingDb` returns `{ healthy: true, latencyMs }` on success and `{ healthy: false, latencyMs, error }` on failure. Currently untested.
- [ ] **Notification consumer: missing `content`/`plaintext` fields** -- Verify that a message with `recipientContactId`, `title`, and `correlationId` present but `content` or `plaintext` missing is handled gracefully (either dropped with a log or delivered with empty content).
- [ ] **Notification consumer: malformed message body** -- Verify that a non-JSON or non-object message body does not crash the consumer (e.g., string body, null body, array body).
- [ ] **Update handler silent no-op** -- Test that `MarkDeliveryRequestProcessed`, `UpdateDeliveryAttemptStatus`, and `UpdateChannelPreferenceRecord` return success even when the target ID does not exist (documenting current behavior), or consider making them check rowCount and return NOT_FOUND.
- [ ] **Proto mapper round-trip** -- Test that `channelPreferenceToProto` correctly maps `Date` fields and that optional proto fields (`userId`, `quietHoursStart`, etc.) are `undefined` in the output.
- [ ] **`getDeliveryStatus` with non-existent ID** -- Verify the gRPC handler returns a NOT_FOUND result (currently tested in `comms-grpc-service.test.ts` but worth confirming the response shape matches proto expectations).
- [ ] **`getChannelPreference` with null preferences** -- Test the gRPC handler behavior when the contact has no saved preferences (currently returns NOT_FOUND -- document if this is intended or a bug).
- [ ] **Composition root: missing email provider** -- Test that `Deliver` handler is not resolvable from DI when `IEmailProviderKey` is not registered (the app registration calls `sp.resolve(IEmailProviderKey)` which would throw). Verify the error path.
- [ ] **Retry topology idempotency** -- Test that calling `declareRetryTopology(messageBus)` multiple times does not fail or create duplicate queues/exchanges.

**Tests to remove**: None -- all existing tests are valid and cover meaningful scenarios.
