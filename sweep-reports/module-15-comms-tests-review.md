### Module 15: Comms Tests Review

**Package:** `@d2/comms-tests` (`backends/node/services/comms/tests/`)
**Files reviewed:** 38 test files + 6 helper/config files

---

**Findings**:

| #  | Severity | Category     | File                                                  | Description                                                                                                                                                                                                                                                                                           |
|----|----------|--------------|-------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1  | Medium   | Coverage Gap | (missing)                                             | **CheckHealth handler has zero test coverage.** `comms-app` exports `CheckHealth` (aggregated health check) but no test file exists for it. This handler has branching logic for DB healthy/unhealthy, messaging configured/not-configured/unhealthy, and the overall "healthy" vs "degraded" status.  |
| 2  | Medium   | Coverage Gap | (missing)                                             | **PingDb repository handler has zero test coverage.** The `PingDb` handler in `comms-infra` runs `SELECT 1` with latency measurement and error handling, but no integration test validates it against real Postgres.                                                                                  |
| 3  | Medium   | Coverage Gap | (missing)                                             | **Channel preference repository has no dedicated integration test.** `delivery-attempt-repository.test.ts`, `delivery-request-repository.test.ts`, and `message-repository.test.ts` all exist, but there is no `channel-preference-repository.test.ts`. It is partially tested via `deliver-handler.test.ts` integration (set/get preference tests), but CRUD operations like create, findByContactId returning null, and update are not independently validated against real Postgres. |
| 4  | Low      | Coverage Gap | `unit/api/comms-grpc-service.test.ts`                 | **checkHealth RPC not tested.** The gRPC service test covers `getChannelPreference`, `setChannelPreference`, `getDeliveryStatus`, and all stub RPCs, but the `checkHealth` RPC handler is absent from the test file.                                                                                  |
| 5  | Low      | Coverage Gap | `unit/app/handlers/deliver.test.ts`                   | **No test for Zod input validation in Deliver handler.** The Deliver handler likely validates input (missing `senderService`, missing `content`, etc.) but unit tests don't cover validation failures at the input level. The `notify.test.ts` tests validation thoroughly; `deliver.test.ts` does not. |
| 6  | Low      | Coverage Gap | `unit/infra/resend-email-provider.test.ts`            | **No test for thrown exceptions from Resend SDK.** Only `mockSend.mockResolvedValue` with `error` field is tested. If `mockSend` throws (e.g., network failure), behavior is untested. The Twilio test covers thrown exceptions (`mockCreate.mockRejectedValue`) but Resend does not.                  |
| 7  | Info     | Quality      | `unit/infra/resend-email-provider.test.ts`            | **Uses `vi.mock` module mocking for `resend` package.** This is one of only two test files that use `vi.mock` (the other is `twilio-sms-provider.test.ts`). Both are justified since they mock external SDK boundaries, which aligns with the project principle "Use `vi.mock` only for infrastructure boundaries." |
| 8  | Info     | Quality      | `unit/app/helpers/mock-handlers.ts`                   | **Well-structured mock factory.** The `okHandler` generic pattern and typed mock factories (`createMockMessageRepo`, `createMockRequestRepo`, etc.) provide clean reusable mocking without module-level `vi.mock`. Good adherence to DI-based testing.                                                 |
| 9  | Info     | Quality      | `integration/helpers/handler-test-helpers.ts`         | **StubEmailProvider properly extends BaseHandler.** Rather than a plain mock, it extends `BaseHandler<SendEmailInput, SendEmailOutput>` and captures emails in memory. This gives integration tests real OTel span behavior while still being controllable.                                            |
| 10 | Info     | Quality      | `integration/notification-consumer.test.ts`           | **Excellent retry integration test.** The test at line 207 validates the full DLX-based retry cycle (publish -> consume -> DELIVERY_FAILED -> tier-1 queue -> TTL expiry -> requeue exchange -> re-consume -> success). Uses real RabbitMQ via Testcontainers with appropriate 15s timeout for tier-1 5s TTL. |
| 11 | Info     | Quality      | `integration/deliver-handler.test.ts`                 | **Thorough integration testing of delivery pipeline.** Tests validate actual DB records via Drizzle queries (not just handler return values), check idempotency via correlationId, channel preference integration, and email provider failure paths. Very solid end-to-end-in-a-box coverage.          |
| 12 | Info     | Organization | `unit/domain/`                                        | **Domain tests are well-organized.** Separate files for each entity, enum, rule, and exception. Tests cover creation, validation errors, state transitions, boundary conditions, and edge cases comprehensively.                                                                                      |
| 13 | Low      | Quality      | `integration/helpers/postgres-test-helpers.ts`        | **Module-level mutable state for container/pool/db.** The helper uses module-level `let` variables shared across all integration tests. This works because Vitest runs each test file in its own module scope, but could be fragile if test files are ever merged. Not a bug, but worth noting.         |
| 14 | Low      | Coverage Gap | `integration/notification-consumer.test.ts`           | **No test for max-attempts-reached drop.** The consumer's `scheduleRetry` function logs an error and drops the message when `getRetryTierQueue` returns null (retryCount >= 10). The integration test validates single retry but not the max-attempts terminal path.                                   |
| 15 | Low      | Coverage Gap | `integration/notification-consumer.test.ts`           | **No test for invalid message body (missing required fields).** The consumer checks `!body.recipientContactId || !body.title || !body.correlationId` and drops invalid messages. No test publishes a malformed message to verify this path.                                                           |
| 16 | Info     | Quality      | `unit/client/notify.test.ts`                          | **Uses custom D2Result matchers well.** Tests use `toBeFailure()`, `toBeSuccess()`, `toHaveStatusCode()`, `toHaveErrorCode()` from `@d2/testing`, demonstrating good use of the project's custom assertion library.                                                                                   |
| 17 | Info     | Documentation| `vitest.config.ts`                                    | **Clean config.** Minimal config that merges shared Vitest config with project-specific setup file. No unnecessary overrides.                                                                                                                                                                         |
| 18 | Info     | Organization | Test file count                                       | **38 test files is appropriate** for the scope of the comms service (domain entities, enums, rules, exceptions, app handlers, infra providers/topology, API service/mappers/interceptor, client). No bloated or redundant files detected.                                                              |
| 19 | Low      | Coverage Gap | `unit/app/handlers/deliver.test.ts`                   | **No test for `markProcessed` being called.** The unit test validates `messageRepo.create.handleAsync` and `requestRepo.create.handleAsync` are called, and `emailProvider.handleAsync` is called, but doesn't verify `requestRepo.markProcessed.handleAsync` is called on success. The integration test covers this (finding 12, line 252), so this is low severity.  |
| 20 | Info     | Quality      | `unit/domain/entities/delivery-attempt.test.ts`       | **Thorough state machine testing.** Tests cover all valid transitions (pending->sent, pending->failed, failed->retried) and all invalid transitions (sent->failed, retried->pending, pending->retried, failed->sent, failed->pending). Full lifecycle tests included.                                  |
| 21 | Low      | Coverage Gap | `unit/app/handlers/set-channel-preference.test.ts`    | **No test for repo failure propagation.** If `repo.create.handleAsync` or `repo.update.handleAsync` returns a failure D2Result, the handler behavior is untested. The test validates validation failures and both create/update paths, but not infrastructure error handling.                           |
| 22 | Info     | Quality      | `unit/api/api-key-interceptor.test.ts`                | **Good edge case coverage.** Tests cover missing key, invalid key, valid key delegation, multi-key rotation (first key, second key, unknown key), empty key set, and logging. Well-structured security test.                                                                                          |
| 23 | Low      | Coverage Gap | (missing)                                             | **No test for `addCommsApp` or `addCommsInfra` DI registration functions.** These registration functions are exercised indirectly by integration tests (which use the factory functions instead), but the DI-based registration paths are never directly validated. The composition root's DI wiring is untested. |
| 24 | Info     | Quality      | `integration/deliver-handler.test.ts`                 | **IRequestContext includes all required fields.** The test context (line 48) includes `isOrgEmulating` and `isUserImpersonating`, matching the latest IRequestContext shape. Some unit test helpers (`mock-handlers.ts`) use a simpler shape, but this is acceptable for unit tests.                    |

---

**Tests to add** (priority order):

| Priority | Package    | Test                                                                                                                          |
|----------|------------|-------------------------------------------------------------------------------------------------------------------------------|
| High     | comms-app  | `unit/app/handlers/check-health.test.ts` -- Test CheckHealth handler: DB healthy, DB unhealthy, messaging not configured, messaging healthy, messaging unhealthy, overall "healthy" vs "degraded" status determination.  |
| Medium   | comms-infra| `integration/channel-preference-repository.test.ts` -- Dedicated CRUD integration test: create preference, findByContactId (found + not found), update preference, verify DB values.                                    |
| Medium   | comms-infra| `integration/ping-db-repository.test.ts` -- Integration test for PingDb against real Postgres: returns healthy=true with latencyMs on success.                                                                          |
| Medium   | comms-api  | Add `checkHealth` RPC tests to `unit/api/comms-grpc-service.test.ts` -- Test healthy response mapping to proto, unhealthy/degraded response, and error handling.                                                        |
| Low      | comms-infra| `unit/infra/resend-email-provider.test.ts` -- Add test for thrown exception from Resend SDK (`mockSend.mockRejectedValue(new Error("Network failure"))`) to verify 503 response.                                        |
| Low      | comms-infra| `integration/notification-consumer.test.ts` -- Add test for invalid message body (publish message missing `recipientContactId`) to verify it is ACKed and dropped without calling Deliver handler.                       |
| Low      | comms-infra| `integration/notification-consumer.test.ts` -- Add test for max-attempts-reached (publish message with `x-retry-count: 10` header) to verify it is logged and dropped.                                                  |
| Low      | comms-app  | `unit/app/handlers/deliver.test.ts` -- Add Zod input validation tests (empty `senderService`, empty `content`, etc.) and verify `markProcessed` is called on success.                                                   |

**Tests to remove**: None. No redundant or unnecessary tests were found.

**Organizational improvements**:

| Priority | Improvement                                                                                                                                                                                                 |
|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Low      | Consider aligning the unit test context helper (`createMockContext` in `mock-handlers.ts`) with the integration test context (`createTestContext` in `test-context.ts`) to include all `IRequestContext` fields (`isOrgEmulating`, `isUserImpersonating`). Currently the unit mock omits these, which is fine for unit tests but could mask type-level issues. |
| Low      | The integration test directory uses flat file organization (`delivery-attempt-repository.test.ts`, `deliver-handler.test.ts`, etc.). Consider grouping into subdirectories (`integration/repository/`, `integration/messaging/`, `integration/pipeline/`) if more integration tests are added, to mirror the unit test organization pattern. |

---

**Overall assessment**:

The `@d2/comms-tests` package is **well-structured and thorough**. With 481+ tests across 38 files, it provides strong coverage of the comms service's domain layer (entities, enums, rules, exceptions), application layer (Deliver handler, RecipientResolver, channel preference handlers), infrastructure layer (Resend/Twilio providers, retry topology, notification consumer), and API layer (gRPC service, proto mappers, API key interceptor).

**Strengths:**
- Domain entity tests are exemplary: every entity has creation, validation, boundary, state transition, and edge case tests.
- Integration tests use real infrastructure (Testcontainers for Postgres and RabbitMQ) and validate actual DB records, not just handler return values.
- The DLX-based retry integration test (notification-consumer) is particularly impressive, validating the full publish-fail-retry-redeliver cycle against real RabbitMQ.
- Test helpers are well-designed: `StubEmailProvider` extends `BaseHandler` for realistic behavior, `MockGeoHandlers` provides clean test data control, and `mock-handlers.ts` uses typed factory functions over module mocking.
- The `@d2/comms-client` Notify handler tests demonstrate excellent use of custom D2Result matchers.

**Gaps:**
- The CheckHealth handler is the most significant untested component. It has meaningful branching logic (healthy/unhealthy/degraded/not-configured) that warrants a unit test file.
- Channel preference repository lacks a dedicated integration test (partially covered via deliver-handler integration).
- The notification consumer's error handling edge cases (invalid message body, max-attempts drop) are untested.
- Minor: Resend thrown exception path, Deliver handler Zod validation, DI registration functions.

The overall test quality is high. The identified gaps are relatively minor and focused on secondary paths rather than core business logic. The test architecture (separate test project, DI-based mocking, Testcontainers integration) follows project conventions established in CLAUDE.md.
